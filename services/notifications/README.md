# Notification Service

Сервис уведомлений на базе NestJS, который обрабатывает и отправляет различные типы уведомлений через разные каналы связи.

## Описание

Сервис уведомлений является микросервисом, который отвечает за отправку уведомлений пользователям через различные каналы связи. Сервис поддерживает отправку уведомлений через email, SMS и Telegram.

## Технологии

- NestJS
- Redis
- RabbitMQ
- NodeMailer
- TypeScript
- MS SQL Server
- TypeOrm
- Swagger

## Запуск сервиса

1. Установите зависимости:
```bash
npm install
```

1. Создайте файлы `.env`, `.env.development` и `.env.production` на основе `env_template`

2. Запустите сервис:
```bash
npm run start
```

Сервис запускается на порту 8009 по умолчанию.

## Архитектура

### Основные компоненты

1. **Модули**:
   - `NotificationModule` - основной модуль обработки уведомлений
   - `DatabaseModule` - работа с базой данных
   - `RedisModule` - интеграция с Redis
   - `RabbitMQModule` - интеграция с RabbitMQ
   - `NodeMailerModule` - отправка email
   - `NodeTelegramModule` - отправка сообщений в Telegram
   - `CheckHealthDbModule` - проверка состояния базы данных
   - `LoggerModule` - система логирования

2. **Стратегии уведомлений**:
   - Email уведомления
   - SMS уведомления
   - Telegram уведомления

### Сервисы мониторинга и поддержки

1. **Система логирования**:
   - Файловое логирование через `FileLogger`
   - Логирование критических ошибок
   - Логирование состояния сервисов
   - Логирование входящих/исходящих сообщений

2. **Мониторинг состояния**:
   - Проверка состояния базы данных через `CheckHealthDbModule`
   - Мониторинг Redis соединения
   - Мониторинг RabbitMQ соединения
   - Heartbeat проверки

3. **Обработка ошибок**:
   - Глобальный обработчик ошибок (`GlobalFilter`)
   - Обработка необработанных исключений
   - Обработка необработанных отклонений промисов
   - Отправка критических ошибок в Redis

4. **Критический Redis**:
   - Отдельное соединение для критических ошибок
   - Публикация ошибок в канал `CRITICAL_ERRORS`
   - Мониторинг состояния сервера
   - Graceful shutdown при критических ошибках

5. **Проверка зависимостей**:
   - Валидация конфигураций при старте
   - Проверка доступности внешних сервисов
   - Мониторинг состояния очередей
   - Проверка соединений с базой данных

### Интеграции

#### Redis
- Обработка критических ошибок
- Каналы для сообщений
- Мониторинг heartbeat

#### RabbitMQ
- Получение сообщений для уведомлений
- Подтверждение доставки (acknowledgment)
- Очереди для данных уведомлений

#### База данных
- Управление пинкодами
- Отслеживание отправленных уведомлений
- Информация о пользователях
- Информация о пользователях Telegram

## API Documentation

Swagger документация доступна по адресу: `http://localhost:8009/api-docs`

## Обработка ошибок

Сервис включает в себя:
- Глобальный обработчик ошибок
- Отправку критических ошибок в Redis
- Логирование всех ошибок
- Graceful shutdown при критических ошибках
- Валидацию входящих данных
- Восстановление после сбоев
- Автоматическое переподключение к внешним сервисам

## Мониторинг

- Отслеживание состояния базы данных
- Мониторинг критических ошибок
- Логирование всех важных событий
- Проверка состояния внешних сервисов
- Мониторинг очередей сообщений
- Отслеживание производительности
- Мониторинг использования ресурсов

## Разработка

### Структура проекта

```
src/
├── configs/         # Конфигурации
├── controllers/     # Контроллеры
├── dto/            # Data Transfer Objects
├── errors/         # Обработка ошибок
├── filters/        # Фильтры
├── i18n/           # Интернационализация
├── interceptors/   # Интерцепторы
├── interfaces/     # Интерфейсы
├── modules/        # Модули приложения
├── pipes/          # Pipes
├── services/       # Сервисы
├── types/          # Типы
└── utils/          # Утилиты
```

### Тестирование

```bash
npm run test:cov    # запуск тестов с покрытием
```

## Безопасность

- Валидация входящих данных
- Безопасное хранение конфигураций
- Обработка критических ошибок
- Защита от необработанных исключений
